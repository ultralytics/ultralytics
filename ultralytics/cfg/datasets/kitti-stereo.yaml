# Ultralytics üöÄ AGPL-3.0 License - https://ultralytics.com/license

# KITTI Stereo Detection dataset by Karlsruhe Institute of Technology and Toyota Technological Institute at Chicago
# Documentation: https://www.cvlibs.net/datasets/kitti/
# Example usage: yolo train data=kitti-stereo.yaml
#
# Label format (22 values): class x_l y_l w_l h_l x_r w_r dim_h dim_w dim_l alpha v1_x v1_y v2_x v2_y v3_x v3_y v4_x v4_y X Y Z
# Where: x_l,y_l,w_l,h_l = left 2D box (normalized), x_r,w_r = right 2D box center_x and width (normalized)
#        dim_h,dim_w,dim_l = 3D dimensions (meters), alpha = observation angle (radians)
#        v1-v4 = 4 bottom vertices (normalized), X,Y,Z = 3D location (camera coords)
# parent
# ‚îú‚îÄ‚îÄ ultralytics
# ‚îî‚îÄ‚îÄ datasets
#     ‚îî‚îÄ‚îÄ kitti-stereo ‚Üê downloads here (~12 GB for object detection data)

# Train/val/test sets as 1) dir: path/to/imgs, 2) file: path/to/imgs.txt, or 3) list: [path/to/imgs1, path/to/imgs2, ..]
path: ../datasets/kitti-stereo # dataset root dir
train: images/train/left # train images (left stereo) (relative to 'path')
val: images/val/left # val images (left stereo) (relative to 'path')

# Stereo image pairs (for stereo-based 3D detection)
train_right: images/train/right # train images (right stereo) (relative to 'path')
val_right: images/val/right # val images (right stereo) (relative to 'path')

# Classes (same as KITTI detection)
names:
  0: Car
  1: Van
  2: Truck
  3: Pedestrian
  4: Person_sitting
  5: Cyclist
  6: Tram
  7: Misc

# Download script/URL (optional)
download: |
  import os
  import shutil
  from pathlib import Path

  from ultralytics.utils import LOGGER, TQDM
  from ultralytics.utils.downloads import download

  # Output directory for converted dataset
  dir = Path(yaml["path"]).resolve()

  # Early exit: if converted dataset already exists, skip download/convert
  if (dir / "images" / "train" / "left").exists() and (dir / "labels" / "train").exists():
      LOGGER.info(f"Using existing KITTI Stereo dataset at: {dir} (skipping download/convert)")
      return

  LOGGER.info("=" * 60)
  LOGGER.info("KITTI Stereo Dataset Download and Conversion")
  LOGGER.info("=" * 60)

  # KITTI dataset S3 URLs
  kitti_urls = {
      "image_2": "https://s3.eu-central-1.amazonaws.com/avg-kitti/data_object_image_2.zip",  # left images
      "image_3": "https://s3.eu-central-1.amazonaws.com/avg-kitti/data_object_image_3.zip",  # right images
      "label_2": "https://s3.eu-central-1.amazonaws.com/avg-kitti/data_object_label_2.zip",  # labels
      "calib": "https://s3.eu-central-1.amazonaws.com/avg-kitti/data_object_calib.zip",  # calibration
  }

  # Download location (raw KITTI data)
  kitti_raw = dir.parent / "kitti_raw"
  kitti_raw.mkdir(parents=True, exist_ok=True)

  def reorganize_kitti_structure(root_path):
      """Reorganize KITTI files if they were extracted to wrong locations."""
      training_dir = root_path / "training"
      training_dir.mkdir(parents=True, exist_ok=True)

      reorganize_map = {
          "data_object_image_2": ("training", "image_2"),
          "data_object_image_3": ("training", "image_3"),
          "data_object_label_2": ("training", "label_2"),
          "data_object_calib": ("training", "calib"),
      }

      for src_dir_name, (split, target_subdir) in reorganize_map.items():
          src_dir = root_path / src_dir_name / split / target_subdir
          dest_dir = training_dir / target_subdir

          if src_dir.exists():
              if dest_dir.exists():
                  LOGGER.info(f"Merging {src_dir_name}/{split}/{target_subdir} into training/{target_subdir}...")
                  for item in src_dir.iterdir():
                      dest_item = dest_dir / item.name
                      if item.is_file() and not dest_item.exists():
                          shutil.copy2(item, dest_item)
                  try:
                      shutil.rmtree(src_dir.parent.parent)
                  except Exception:
                      pass
              else:
                  LOGGER.info(f"Moving {src_dir_name}/{split}/{target_subdir} to training/{target_subdir}...")
                  dest_dir.parent.mkdir(parents=True, exist_ok=True)
                  shutil.move(str(src_dir), str(dest_dir))
                  try:
                      shutil.rmtree(src_dir.parent.parent)
                  except Exception:
                      pass

  def check_kitti_ready(root_path):
      """Check if KITTI raw data is ready for conversion."""
      training_dir = root_path / "training"
      return (
          (training_dir / "image_2").exists()
          and (training_dir / "image_3").exists()
          and (training_dir / "label_2").exists()
          and (training_dir / "calib").exists()
      )

  # Download if not already present
  if not check_kitti_ready(kitti_raw):
      LOGGER.info(f"Downloading KITTI dataset to: {kitti_raw}")
      LOGGER.info("This may take a while (~12 GB to download)...")

      for key, url in kitti_urls.items():
          LOGGER.info(f"Downloading {key}...")
          download(url, kitti_raw, unzip=True, delete=True, exist_ok=True)

      # Reorganize if needed
      reorganize_kitti_structure(kitti_raw)

  # Verify KITTI structure
  if not check_kitti_ready(kitti_raw):
      raise FileNotFoundError(
          f"KITTI data not found at {kitti_raw / 'training'}. "
          "Please check the download or set KITTI_ROOT environment variable."
      )

  LOGGER.info(f"KITTI raw data ready at: {kitti_raw}")

  # Import and use the converter
  from ultralytics.data.scripts.convert_kitti_3d import KITTIToYOLO3D

  LOGGER.info(f"Converting KITTI dataset to YOLO 3D format at: {dir}")

  # Use 3dop split strategy: training set split into train (0-3711) and val (3712+)
  converter = KITTIToYOLO3D(
      kitti_root=kitti_raw,
      output_root=dir,
      filter_classes=None,  # Include all classes
      split_strategy="3dop",
  )

  # Convert the training split (will create both train and val with 3dop strategy)
  converter.convert_split("training")

  # Create dataset.yaml
  converter.create_dataset_yaml()

  LOGGER.info("")
  LOGGER.info("=" * 60)
  LOGGER.info("KITTI Stereo Dataset Conversion Complete!")
  LOGGER.info(f"Dataset saved to: {dir}")
  LOGGER.info("=" * 60)
