"""
Homography变换使用指南

本文档说明如何使用Homography变换将像素坐标转换为实际世界坐标
"""

# ============================================================================
# 第1步：标定（一次性，对每个视频进行）
# ============================================================================

# 从视频提取第一帧并进行标定
python examples/trajectory_demo/calibration.py --video videos/NewYorkSample.mp4 --output calibration/

# 程序会：
# 1. 提取视频第一帧
# 2. 显示图像，要求点击4个参考点
# 3. 输入这些点的实际世界坐标（单位：米）
# 4. 自动计算Homography矩阵
# 5. 保存矩阵到 calibration/NewYorkSample_homography.json

# 【标定技巧】
# - 选择已知距离的4个点，比如：
#   * 车道线的四个角
#   * 停止线上的标记
#   * 人行横道的四个角
# - 如果不知道实际距离，可以用相对坐标（比如都乘以10）
# - 至少要覆盖图像的四个区域，这样变换才准确

# ============================================================================
# 第2步：运行追踪（加上--homography参数）
# ============================================================================

python examples/trajectory_demo/yolo_runner.py \
  --source videos/NewYorkSample.mp4 \
  --conf 0.45 \
  --homography calibration/NewYorkSample_homography.json

# 输出会显示：
# ✓ Homography矩阵已加载，距离将转换为实际世界坐标（米）

# 报告中的距离现在是"米"而不是"像素"！

# ============================================================================
# 第3步：查看结果
# ============================================================================

# 查看分析报告
cat runs/trajectory_demo/NewYorkSample_*/analysis_report.txt

# 距离统计现在显示的是米，而不是像素：
# Distance Statistics (meters):
#   Average: 12.34
#   Minimum: 0.91
#   Maximum: 149.92

# ============================================================================
# 常见问题
# ============================================================================

# Q1: Homography矩阵是什么？
# A: 一个3x3矩阵，描述了二维平面的变换关系
#    在这里，它定义了视频图像（俯视图）和实际地面的对应关系

# Q2: 为什么要选4个点？
# A: 因为Homography是一个8自由度的变换（9个参数减去整体缩放）
#    4个点x2坐标 = 8个约束，正好确定Homography

# Q3: 不同视频需要重新标定吗？
# A: 是的。不同相机位置/角度 → 不同Homography
#    但如果是同一个固定摄像头，可以重用之前的标定

# Q4: 标定误差会影响结果吗？
# A: 会的。标定误差会导致距离计算偏差
#    选择更精确的参考点可以改善

# Q5: 可以用其他方法代替Homography吗？
# A: 可以：
#    - 相机标定（内参+外参）：更精确，但需要特殊标定板
#    - 深度摄像头：直接获得深度信息
#    - 激光雷达：高精度3D信息

# ============================================================================
# 工作流总结
# ============================================================================

# 1. 视频 → calibration.py → Homography矩阵 (JSON)
# 2. 视频 + Homography矩阵 → yolo_runner.py (--homography参数)
# 3. YOLO检测 + 坐标变换 → 世界坐标轨迹
# 4. 距离计算现在是米而不是像素！

# ============================================================================
# 代码流程
# ============================================================================

# calibration.py:
#   1. 提取视频第一帧
#   2. 用户点击4个参考点（像素坐标）
#   3. 用户输入世界坐标
#   4. cv2.findHomography() 计算矩阵
#   5. 保存到JSON

# yolo_runner.py:
#   1. 加载 --homography 参数的JSON文件
#   2. 把矩阵传给 ObjectStateManager
#   3. OSM自动进行坐标变换（在update()中）

# object_state_manager.py:
#   1. 对每个检测到的点(cx, cy)
#   2. 使用cv2.perspectiveTransform()变换到世界坐标
#   3. 同时保存像素和世界坐标
#   4. distance_between()优先使用世界坐标计算距离

# ============================================================================
"""
